<!DOCTYPE html>
<html>
    <head>
        <script src="jquery-1.6.4.js" type="text/javascript"></script>
        <script src="jquerymx-3.2.custom.js" type="text/javascript"></script>

        <script type="text/javascript">
            $(function() {
			
                $.Class('Game',{
                    fps: 60,
                    viewWidth: 500,
                    viewHeight: 500,
                    worldWidth: 2000,
                    worldHeight: 2000,
                    numLayers: 2
                },{
                    init: function() {
                        
                        // Create jQuery object 
                        this.$object = $("#game").width(Game.viewWidth).height(Game.viewHeight);
                        
                        // Create layers (each is a canvas)
                        this.layers = {};
                        for (i = 0; i < Game.numLayers; i++) {
                            var layer = $('<canvas class="layer layer'+ i +'"></canvas>').appendTo(this.$object)
                                .attr('width',Game.viewWidth)
                                .attr('height',Game.viewHeight)
                                .css('z-index', i);
                            
                            this.layers[i] = layer.get(0);
                        }
                        
                        // A buffer layer
                        this.mapBuffer = $('<canvas class="layer buffer"></canvas>').appendTo(this.$object)
                            .attr('width',Game.worldWidth)
                            .attr('height',Game.worldHeight).get(0);
                        
                        // World
                        this.world = new World(this, Game.worldWidth, Game.worldHeight);
                        
                        // View (camera)
                        this.view = {
                            x: 0,
                            y: 0,
                            scale: 1
                        }
                        
                        // Game loop
                        var self = this;
                        setInterval(function() { self.gameLoop() }, 1000 / Game.fps);
                        
                        // Keyboard states
                        this.keysDown = {};
                        
                        // Mouse state
                        this.mouse = {
                            canvas: {
                                x:0,
                                y:0
                            },
                            world: {
                                x:0,
                                y:0
                            }
                        }
                        
                        this.translation = {};
                        this.lastTimestamp = new Date().getTime();
                        
                        
                        // Keyboard handlers
                        this.$object.keydown(function(event) { 
                            self.keysDown[event.keyCode] = true; 
                            
                            console.log(event.keyCode);
                        });
                        
                        this.$object.keyup(function(event) {
                            delete self.keysDown[event.keyCode];
                        });
                        
                        this.$object.mousemove(function(event) { 
                            
                            self.mouse.canvas.x = event.pageX - this.offsetLeft;
                            self.mouse.canvas.y = event.pageY - this.offsetTop;
                        
                        });
                        
                        this.$object.mousedown(function(event) { 
                            var x = event.pageX - this.offsetLeft - self.translation.x;
                            var y = event.pageY - this.offsetTop - self.translation.y;
                            self.world.handleMouseDown(new Vector(x,y));
                        });
                        
                        this.$object.mouseup(function(event) { 
                            var x = event.pageX - this.offsetLeft - self.translation.x;
                            var y = event.pageY - this.offsetTop - self.translation.y;
                            self.world.handleMouseUp(new Vector(x,y));
                        });
                    },
                    gameLoop: function() {
                        
                        // Calculate delta
                        var currentTimestamp = new Date().getTime();
                        var delta = currentTimestamp - this.lastTimestamp;
                        this.lastTimestamp = currentTimestamp;
                        
                        
                        this.handleInput(delta);
                        
                        this.update(delta);
                        
                        this.draw();
                    },
                    handleInput: function(delta) {
                        
                        // Camera speed
                        var speed = 0.3;
                        
                        // Key presses
                        if (38 in this.keysDown) {  /* Up arrow was pressed */
                            this.view.y-= delta * speed;
                        }
                        
                        if (40 in this.keysDown) {  /* Down arrow was pressed */
                            this.view.y+= delta * speed;
                        }
                        
                        if (37 in this.keysDown) {  /* Left arrow was pressed */
                            this.view.x-= delta * speed;
                        }
                        
                        if (39 in this.keysDown) {  /* Right arrow was pressed */
                            this.view.x+= delta * speed;
                        }
                        
                        
                        // Update world coords depending on the position of the view/camera
                        this.translation = new Vector(
                            (Game.viewWidth / 2) - this.view.x,
                            (Game.viewHeight / 2) - this.view.y
                        );
                        
                        // Round numbes..
                        this.translation.round();
                        
                        // Mosue input
                        this.mouse.world.x = this.mouse.canvas.x - this.translation.x,
                        this.mouse.world.y = this.mouse.canvas.y - this.translation.y;
                    },
                    update: function(delta) {
                        this.world.update(delta);
                    },
                    draw: function () {
                        
                        //// Layer 0, the background of tiles
                    
                        // Draw world things
                        this.world.draw(this.layers[0]);
                       
                        
                        //// Layer 1, the foreground
                        
                        var layer1 = this.layers[1].getContext("2d");
                        
                        layer1.clearRect(0, 0, Game.viewWidth, Game.viewHeight);
                        layer1.translate(this.translation.x, this.translation.y);
                        for (i in this.world.units) {
                            
                            this.world.units[i].draw(layer1);
                        }
                        layer1.translate(-this.translation.x, -this.translation.y);
                        
                    }
                });
                
                $.Class('World',{},{
                    init: function(game, width, height) {
                        this.game = game;
                        this.pos = new Vector(0,0);
                        this.width = width;
                        this.height = height;
                        
                        this.mouseDown = false;
                        this.redraw = true;
                        this.hexagonsToRedraw = [];
                        this.lastTranslation = {x:0, y:0};
                        
                        this.hexagons = [];
                        this.hexagonsMap = {};
                        for (y = 0; y < 200; y++) {
                            this.hexagonsMap[y] = {};
                            for (x = 0; x < 200; x++) {
                                var xoffset = Hexagon.h + Hexagon.side;
                                var yoffset = Hexagon.r * 2;
                                var ychange = 0;
                                if (x % 2 == 1) {
                                    ychange = -Hexagon.r;
                                    //xoffset -= 3;
                                }
                                
                                var pos = new Vector(x * xoffset, y * yoffset + ychange);
                                pos.round();
                                
                                var hex = new Hexagon(pos, new Vector(x,y));
                                
                                this.hexagons.push(hex);
                                this.hexagonsMap[y][x] = hex;
                            }
                        }
                        
                        this.units = [];
                        this.units.push(new Unit(new Vector(50,50), this.hexagons[1] ));
                    },
                    update: function(delta) {
                        
                        var mouse = this.game.mouse.world;
                        var hexChanged = false;
                        
                        var mouseTileEstimate = new Vector(mouse.x/(Hexagon.side + Hexagon.h), mouse.y/(Hexagon.r*2));
                        mouseTileEstimate.round();
                        
                        var range = 2;
                        
                        for (x = mouseTileEstimate.x - range; x < mouseTileEstimate.x + range; x++) {
                            for (y = mouseTileEstimate.y - range; y < mouseTileEstimate.y + range; y++) {
    
                                
                                if (this.hexagonsMap[y] == undefined || this.hexagonsMap[y][x] == undefined) {
                                    continue;
                                }
                                
                                var hex = this.hexagonsMap[y][x];
                                
                                hexChanged = false;

                                // See if mouse is hovering over this hex
                                if (Math.pow(hex.centrePos.x - mouse.x, 2) + Math.pow(hex.centrePos.y - mouse.y, 2) <= Math.pow(Hexagon.radius,2)) {
                                    hex.hovered = true;
                                    hexChanged = true; 
                                } else if (hex.hovered) {
                                    hex.hovered = false;
                                    hexChanged = true;
                                }

                                // See if hex has been clicked
                                if (this.mouseDown && hex.hovered) {
                                    hex.highlighted = true;
                                    hexChanged = true;

                                } else if (!this.mouseDown && hex.highlighted) {
                                    hex.highlighted = false;
                                    hexChanged = true;
                                }

                                // If hex has changed at all, redraw it
                                if (hexChanged) {
                                    this.hexagonsToRedraw.push(hex);
                                }
                            }
                        }
                        
                        
                        
                    },
                    draw: function(canvas) {
                        
                        var context = canvas.getContext("2d");

                        var mapBuffer = this.game.mapBuffer;
                        var mapContext = mapBuffer.getContext('2d');
                        
                        if (this.redraw) {
                            
                            this.redraw = false;
                            
                            // Clear the map
                            mapContext.clearRect(0, 0, Game.viewWidth, Game.viewHeight);
                            
                            // Draw the hexagons
                            for (i in this.hexagons) {
                                this.hexagons[i].draw(mapContext);
                            }
                        }
                        if (this.hexagonsToRedraw.length > 0) {
                            
                            // Redraw just the selected hexagons
                            for (i in this.hexagonsToRedraw) {
                                this.hexagonsToRedraw[i].draw(mapContext);
                            }
                            
                            this.hexagonsToRedraw = [];
                        }
                        
                        context.save();
                        context.clearRect(0, 0, Game.viewWidth, Game.viewHeight);
                        context.translate(this.game.translation.x, this.game.translation.y);
                        context.drawImage(mapBuffer, 0, 0);
                        context.restore();
                    },
                    handleMouseDown: function(pos) {
                        this.mouseDown = true;
                    },
                    handleMouseUp: function(pos) {
                        this.mouseDown = false;
                        
                        for (i in this.hexagons) {
                            var hex = this.hexagons[i];
                            if (hex.highlighted) {
                                hex.selected = true;
                                
                                this.hexagonsToRedraw.push(hex);
                            }
                        }
                    }
                });
                
                $.Class('Hexagon',{
                    side: 30,
                    h: Math.sin(0.523598776) * 30,
                    r: Math.cos(0.523598776) * 30,
                    radius: 28
                },{
                    init: function(pos, slot) {
                        this.pos = pos;
                        this.slot = slot;
                        this.centrePos = new Vector(pos.x + (Hexagon.side / 2), pos.y + Hexagon.r);
                        
                        this.hovered = false;
                        this.highlighted = false;
                        this.selected = false
                        
                        this.points = {};
                        
                        this.points[0] = new Vector(this.pos.x, this.pos.y).round();
                        this.points[1] = new Vector(this.pos.x + Hexagon.side, this.pos.y).round();
                        this.points[2] = new Vector(this.pos.x + Hexagon.side + Hexagon.h, this.pos.y + Hexagon.r).round();
                        this.points[3] = new Vector(this.pos.x + Hexagon.side, this.pos.y + Hexagon.r + Hexagon.r).round();
                        this.points[4] = new Vector(this.pos.x, this.pos.y + Hexagon.r + Hexagon.r).round();
                        this.points[5] = new Vector(this.pos.x - Hexagon.h, this.pos.y + Hexagon.r ).round();
                    },
                    draw: function(context) {
                        
                        if (this.selected) {
                            context.fillStyle = "#000000";
                        }
                        else if (this.highlighted && this.hovered) {
                            context.fillStyle = "#AD03AD";
                        }
                        else if (this.highlighted) {
                            context.fillStyle = "#DD00DD";
                        }
                        else if (this.hovered) {
                            context.fillStyle = "#DDDDDD";
                        } else {
                            context.fillStyle = "#EFEFEF";
                        }
                        context.strokeStyle = "#9CAFEA";
                        
                        context.beginPath();
                        
                        context.moveTo(this.points[5].x, this.points[5].y);
                        
                        for (i in this.points) {
                            context.lineTo(this.points[i].x, this.points[i].y);
                            
                        }
                        
                        context.closePath();
                        context.stroke(); 
                        context.fill();
                        
                    }
                });
                
                $.Class('Path',{},{
                    init: function() {
                        this.tiles = [];
                    },
                    clear: function() {
                        this.tiles = [];
                    },
                    add: function(tile) {
                        this.tiles.push(tile);
                    }
                });
                
                $.Class('Vector',{},{
                    init: function(x, y) {
                        this.x = x;
                        this.y = y;
                    },
                    round: function() {
                        this.x = (0.5 + this.x) << 0;
                        this.y = (0.5 + this.y) << 0;
                        return this;
                    }
                });
                
                $.Class('Unit',{},{
                    init: function(pos, hexagon) {
                        this.pos = pos;
                        this.hexagon = hexagon;
                    },
                    update: function(delta) {
                        
                    },
                    draw: function(context) {
                        context.fillStyle = "#000000";
                        context.beginPath();
                        context.arc(this.hexagon.centrePos.x, this.hexagon.centrePos.y, 10, 0, Math.PI*2, true);
                        context.closePath()
                        context.fill();
                    }
                });
                
			
                
                var game = new Game();
            });
        </script>


        <style type="text/css">
            body {
                background: #EEEEEE;
                text-align: center;
                font-family: Arial;
            }
            #game {
                margin: 10px auto;
                display: block;
                background: #FFFFFF;
                position: relative;
                overflow: hidden;
            }
            .layer {
                position: absolute;
                top: 0;
                left: 0;
            }
            .buffer {
                visibility: hidden;
            }
        </style>
    </head>
    <body>
        <h2>Project X prototype</h2>
        <div id="game" tabindex="1">
            
        </div>
    </body>
</html>